<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paiement — ArionsDesign</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f2f4f7;
  margin: 0;
  overflow-x: hidden;
}

/* HEADER */
header {
  background: white;
  padding: 14px;
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 1px solid #ddd;
}

header a {
  text-decoration: none;
  font-size: 18px;
  color: #0f4af1;
}

/* CONTAINER */
.container {
  padding: 14px;
  max-width: 100%;
}

label {
  font-size: 15px;
  font-weight: 600;
  margin-top: 10px;
  display: block;
}

input, select {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: white;
  margin-top: 6px;
  margin-bottom: 14px;
}

/* MM INFO */
#mmInfo {
  display: none;
  background: white;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.mmLine {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.copyBtn {
  padding: 6px 12px;
  background: #0f4af1;
  border: none;
  color: white;
  border-radius: 8px;
  font-size: 13px;
}

/* TOTAL */
.box {
  background: white;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  margin-top: 14px;
}

.total {
  font-size: 22px;
  color: #0f4af1;
  font-weight: 800;
  text-align: right;
}

/* BUTTON */
.btn {
  background: #0f4af1;
  color: white;
  width: 100%;
  border: none;
  padding: 15px;
  font-size: 17px;
  border-radius: 12px;
  margin-top: 20px;
  font-weight: 600;
}

/* PROOF */
#proofBox {
  display: none;
}
</style>
</head>

<body>

<header>
  <a href="cart.html">← Retour</a>
  <span>Paiement</span>
</header>

<div class="container">

  <h2 style="margin:0 0 15px;">Finaliser la commande</h2>

  <label>Nom complet</label>
  <input id="nameInput" placeholder="Votre nom">

  <label>Numéro de téléphone</label>
  <input id="phoneInput" placeholder="+224 ...">

  <label>Adresse</label>
  <input id="addressInput" placeholder="Où livrer ?">

  <label>Méthode de paiement</label>
  <select id="paymentSelect">
    <option value="COD">Paiement à la livraison</option>
    <option value="MOBILE">Mobile Money (Reçu requis)</option>
  </select>

  <!-- MOBILE MONEY INFO -->
  <div id="mmInfo">
    <p style="font-weight:600;margin-bottom:10px;">Numéros Mobile Money :</p>

    <div class="mmLine">
      <span>Orange Money : <b>620051118</b></span>
      <button class="copyBtn" onclick="copyMM('620051118')">Copier</button>
    </div>

    <div class="mmLine">
      <span>MTN Money : <b>663927500</b></span>
      <button class="copyBtn" onclick="copyMM('663927500')">Copier</button>
    </div>
  </div>

  <div id="proofBox">
    <label>Reçu Mobile Money</label>
    <input type="file" id="proofFile" accept="image/*">
  </div>

  <div class="box">
    <p>Sous-total : <span id="subtotal">0 GNF</span></p>
    <p>Livraison : <span id="delivery">0 GNF</span></p>
    <hr>
    <p class="total">Total : <span id="total">0 GNF</span></p>
  </div>

  <button class="btn" id="placeOrderBtn">Confirmer la commande</button>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://msavtmwvhyboplytisiz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zYXZ0bXd2aHlib3BseXRpc2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MjAxOTAsImV4cCI6MjA4MDE5NjE5MH0.PE_chxqgi335cTnnX4zaPCMTdIzM_LClnpWRRM_007E"
);

/* CART */
function getCart() {
  return JSON.parse(localStorage.getItem("cart") || "[]");
}

function format(n) {
  return new Intl.NumberFormat("fr-FR").format(n) + " GNF";
}

/* TOTALS */
function loadTotals() {
  const cart = getCart();
  let subtotal = 0, delivery = 0;

  cart.forEach(i => {
    const price = Number(i.price_gnf) || 0;
    const qty = Number(i.qty) || 1;
    const deliv = Number(i.delivery_cost || i.delivery_gnf || 0);

    subtotal += price * qty;
    delivery += deliv * qty;
  });

  document.getElementById("subtotal").textContent = format(subtotal);
  document.getElementById("delivery").textContent = format(delivery);
  document.getElementById("total").textContent = format(subtotal + delivery);

  return { subtotal, delivery, total: subtotal + delivery };
}
loadTotals();

/* SHOW/HIDE MM INFO */
paymentSelect.onchange = () => {
  const isMM = paymentSelect.value === "MOBILE";
  document.getElementById("mmInfo").style.display = isMM ? "block" : "none";
  document.getElementById("proofBox").style.display = isMM ? "block" : "none";
};

/* COPY BUTTON */
window.copyMM = function(num) {
  navigator.clipboard.writeText(num);
  alert("Numéro copié : " + num);
};

/* PLACE ORDER */
placeOrderBtn.onclick = async () => {

  const name = nameInput.value.trim();
  const phone = phoneInput.value.trim();
  const address = addressInput.value.trim();
  const payment = paymentSelect.value;

  if (!name || !phone || !address)
    return alert("Veuillez remplir tous les champs.");

  const cart = getCart();
  const totals = loadTotals();

  let proof_url = null;

  if (payment === "MOBILE") {
    const file = proofFile.files[0];
    if (!file) return alert("Veuillez envoyer le reçu Mobile Money.");

    const fileName = "proof_" + Date.now() + "_" + file.name;

    const { error: uploadErr } = await supabase.storage
      .from("payments")
      .upload(fileName, file);

    if (uploadErr) return alert("Erreur upload reçu.");
    proof_url =
      "https://msavtmwvhyboplytisiz.supabase.co/storage/v1/object/public/payments/" + fileName;
  }

  const { error } = await supabase.from("orders").insert({
    customer_name: name,
    phone,
    address,        // MUST EXIST IN TABLE
    items: cart,
    subtotal_gnf: totals.subtotal,
    delivery_gnf: totals.delivery,
    total_gnf: totals.total,
    payment_method: payment,
    proof_url,
    status: "en attente",
    created_at: new Date().toISOString()
  });

  if (error) return alert("Erreur : " + error.message);

  localStorage.removeItem("cart");
  alert("Commande confirmée !");
  location.href = "orders.html";
};
</script>

</body>
</html>